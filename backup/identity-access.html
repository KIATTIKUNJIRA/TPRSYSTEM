<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Identity & Access — TPR Digital Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    body { background:#f7f7fb }
    .badge-role { text-transform: uppercase; letter-spacing: .3px; }
    .sticky-actions { position: sticky; top: 0; background: #fff; z-index: 1; padding: .5rem 0; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold">TPR Digital Hub — Identity & Access</a>
      <div class="ms-auto d-flex gap-2">
        <button id="btnLogout" class="btn btn-sm btn-outline-secondary d-none">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <section id="employeesPanel" class="d-none">
      <div class="sticky-actions d-flex flex-wrap gap-2 align-items-center">
        <div class="input-group" style="max-width: 420px;">
          <span class="input-group-text">ค้นหา</span>
          <input id="q" class="form-control" placeholder="ชื่อ/อีเมล/รหัสพนักงาน">
          <button id="btnSearch" class="btn btn-outline-primary">ค้นหา</button>
        </div>
        <div class="ms-auto d-flex gap-2">
          <button id="btnInvite" class="btn btn-success">+ Invite</button>
          <label class="btn btn-outline-secondary mb-0">
            Bulk invite (CSV)
            <input id="csvFile" type="file" accept=".csv" hidden>
          </label>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-body">
          <div class="row g-2 mb-2">
            <div class="col-auto">
              <select id="fltRole" class="form-select form-select-sm">
                <option value="">All roles</option>
                <option>admin</option>
                <option>hr</option>
                <option>head</option>
                <option>staff</option>
                <option>user</option>
              </select>
            </div>
            <div class="col-auto">
              <select id="fltStatus" class="form-select form-select-sm">
                <option value="">All status</option>
                <option value="active">active</option>
                <option value="inactive">inactive</option>
              </select>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle table-hover" id="tbl">
              <thead class="table-light">
                <tr>
                  <th style="width:48px">#</th>
                  <th>ชื่อ</th>
                  <th>อีเมล</th>
                  <th>บริษัท</th>
                  <th>สิทธิ์</th>
                  <th>สถานะ</th>
                  <th class="text-nowrap">จัดการ</th>
                </tr>
              </thead>
              <tbody id="gridBody"><tr><td colspan="7" class="text-center py-5 text-muted">กำลังโหลด...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div class="modal fade" id="roleModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">เปลี่ยนสิทธิ์ผู้ใช้</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-2"><b id="rmName"></b><div id="rmEmail" class="text-muted small"></div></div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select id="rmRole" class="form-select">
              <option>admin</option>
              <option>hr</option>
              <option>head</option>
              <option>staff</option>
              <option>user</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button id="btnSaveRole" class="btn btn-primary">บันทึก</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">ประวัติการเปลี่ยนสิทธิ์</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead><tr><th>เวลา</th><th>จาก</th><th>เป็น</th><th>ผู้ดำเนินการ</th></tr></thead>
              <tbody id="histRows"><tr><td colspan="4" class="text-center text-muted py-4">ไม่มีข้อมูล</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import './js/config.js';
    import { supa } from './js/lib.supabase.js';
    import { showToast, rlsGuard } from './js/ui.helpers.js';

    // Auth guard
    async function guard() {
      const { data: { user } } = await supa.auth.getUser();
      if (!user) { location.href = 'login.html'; return false; }
      document.getElementById('btnLogout').classList.remove('d-none');
      document.getElementById('employeesPanel').classList.remove('d-none');
      return true;
    }
    document.getElementById('btnLogout').addEventListener('click', async ()=>{
      await supa.auth.signOut();
      showToast('Logged out', 'success');
      location.href = 'login.html';
    });

    // Load employees
    async function loadEmployees() {
      const tbody = document.getElementById('gridBody');
      tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">กำลังโหลด...</td></tr>`;

      const qtxt = document.getElementById('q').value?.trim();
      const role = document.getElementById('fltRole').value;
      const status = document.getElementById('fltStatus').value;

      let req = supa.from('employees_with_roles').select('*').order('email',{ascending:true}).limit(200);
      if (qtxt) req = req.or(`email.ilike.%${qtxt}%,first_name.ilike.%${qtxt}%,last_name.ilike.%${qtxt}%,employee_id.ilike.%${qtxt}%`);
      const { data, error } = await req;
      if (error) { tbody.innerHTML = `<tr><td colspan="7" class="text-danger">${error.message}</td></tr>`; return; }

      let rows = data || [];
      if (role) rows = rows.filter(r => (r.role_y||'')===role);
      if (status) rows = rows.filter(r => (r.status_x||'')===status);
      if (!rows.length) { tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">ไม่พบข้อมูล</td></tr>`; return; }

      tbody.innerHTML = '';
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${(r.first_name||'') + ' ' + (r.last_name||'')}</td>
          <td>${r.email||''}</td>
          <td>${r.company_id||''}</td>
          <td><span class="badge text-bg-secondary badge-role">${r.role_y||''}</span></td>
          <td><span class="badge ${r.status_x==='active'?'text-bg-success':'text-bg-secondary'}">${r.status_x||''}</span></td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-outline-primary" data-invite="${r.email}">Invite</button>
            <button class="btn btn-sm btn-outline-dark" data-role="${r.email}">Change role</button>
            <button class="btn btn-sm btn-outline-secondary" data-hist="${r.email}">History</button>
            <button class="btn btn-sm ${r.status_x==='active'?'btn-outline-warning':'btn-outline-success'}" data-toggle="${r.email}">${r.status_x==='active'?'Deactivate':'Activate'}</button>
          </td>`;
        tbody.appendChild(tr);
      });

      // actions
      tbody.querySelectorAll('button[data-invite]').forEach(btn=> btn.addEventListener('click', ()=> invite(btn.dataset.invite)));
      tbody.querySelectorAll('button[data-role]').forEach(btn=> btn.addEventListener('click', ()=> openRoleModal(btn.dataset.role)));
      tbody.querySelectorAll('button[data-hist]').forEach(btn=> btn.addEventListener('click', ()=> openHistory(btn.dataset.hist)));
      tbody.querySelectorAll('button[data-toggle]').forEach(btn=> btn.addEventListener('click', ()=> toggleStatus(btn.dataset.toggle)));
    }

    document.getElementById('btnSearch').onclick = loadEmployees;
    document.getElementById('fltRole').onchange = loadEmployees;
    document.getElementById('fltStatus').onchange = loadEmployees;
    document.getElementById('q').addEventListener('keydown', e=> { if(e.key==='Enter') loadEmployees(); });

    // Invite via Edge Function
    async function getAccessToken() {
      const { data } = await supa.auth.getSession();
      return data.session?.access_token || '';
    }
    async function invite(email) {
      try {
        const res = await fetch('/functions/v1/invite-user', {
          method:'POST',
          headers: { 'content-type':'application/json', 'authorization': `Bearer ${await getAccessToken()}` },
          body: JSON.stringify({ email })
        });
        const j = await res.json();
        if (!j.ok) throw new Error(j.error || 'invite failed');
        showToast('ส่งคำเชิญแล้ว', 'success');
      } catch (e) { showToast('Invite error: '+ e.message, 'danger'); }
    }

    // Change role
    const roleModal = new bootstrap.Modal(document.getElementById('roleModal'));
    async function openRoleModal(email) {
      const { data, error } = await supa.from('employees_with_roles').select('*').eq('email', email).single();
      if (error) return showToast(error.message, 'danger');
      document.getElementById('rmName').textContent = `${data.first_name||''} ${data.last_name||''}`;
      document.getElementById('rmEmail').textContent = data.email;
      document.getElementById('rmRole').value = data.role_y || 'user';
      roleModal._email = data.email;
      roleModal.show();
    }
    document.getElementById('btnSaveRole').addEventListener('click', async ()=>{
      const email = roleModal._email; if (!email) return;
      const newRole = document.getElementById('rmRole').value;
      try {
        const res = await fetch('/functions/v1/change-role', {
          method:'POST',
          headers: { 'content-type':'application/json', 'authorization': `Bearer ${await getAccessToken()}` },
          body: JSON.stringify({ email, new_role: newRole })
        });
        const j = await res.json();
        if (!j.ok) throw new Error(j.error || 'change role failed');
        showToast('อัปเดตสิทธิ์แล้ว', 'success');
        roleModal.hide();
        loadEmployees();
      } catch (e) { showToast('Change role error: '+ e.message, 'danger'); }
    });

    // History
    const histModal = new bootstrap.Modal(document.getElementById('historyModal'));
    async function openHistory(email) {
      const one = await supa.from('employees_with_roles').select('employee_id_uuid').eq('email', email).single();
      if (one.error) return showToast(one.error.message,'danger');
      const personId = one.data.employee_id_uuid;
      const res = await supa.from('hr.role_history').select('changed_at,old_role_y,new_role_y,actor_uid').eq('person_id', personId).order('changed_at', {ascending:false}).limit(100);
      const tbody = document.getElementById('histRows');
      if (res.error || !res.data?.length) { tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">ไม่มีข้อมูล</td></tr>`; histModal.show(); return; }
      tbody.innerHTML = '';
      res.data.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(r.changed_at).toLocaleString()}</td><td>${r.old_role_y||''}</td><td>${r.new_role_y||''}</td><td>${r.actor_uid||''}</td>`;
        tbody.appendChild(tr);
      });
      histModal.show();
    }

    // Activate/Deactivate
    async function toggleStatus(email) {
      const one = await supa.from('hr.people').select('id,status_x').eq('email', email).single();
      if (one.error) return showToast(one.error.message,'danger');
      const next = (one.data.status_x === 'active') ? 'inactive' : 'active';
      const upd = await supa.from('hr.people').update({ status_x: next }).eq('id', one.data.id);
      if (upd.error) return showToast(upd.error.message,'danger');
      showToast('อัปเดตสถานะแล้ว', 'success');
      loadEmployees();
    }

    if (await guard()) await loadEmployees();
  </script>
</body>
</html>
