<!doctype html>
    <html lang="th">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Projects</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body class="bg-light">
      <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
        <div class="container-fluid">
          <a class="navbar-brand fw-semibold">TPR Digital Hub</a>
          <div class="ms-auto d-flex gap-2">
            <a class="btn btn-sm btn-outline-secondary" href="./projects.html">Projects</a>
            <a class="btn btn-sm btn-outline-secondary" href="./timesheets.html">Timesheets</a>
            <a class="btn btn-sm btn-outline-secondary" href="./project-dashboard.html">Dashboard</a>
          </div>
        </div>
      </nav>
      <main class="container py-4">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="m-0">Projects</h3>
  <div>
    <a class="btn btn-primary" id="btnNew">+ New Project</a>
  </div>
</div>
<div class="input-group mb-3">
  <span class="input-group-text">ค้นหา</span>
  <input id="q" class="form-control" placeholder="ชื่อโครงการ">
  <button id="btnSearch" class="btn btn-outline-primary">ค้นหา</button>
</div>
<table class="table table-hover align-middle">
  <thead><tr><th>#</th><th>ชื่อโครงการ</th><th>สถานะ</th><th>จัดการ</th></tr></thead>
  <tbody id="rows"><tr><td colspan="4" class="text-center text-muted py-4">กำลังโหลด...</td></tr></tbody>
</table>

      </main>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
      <script type="module">
        import './js/config.js';
        import './js/lib.supabase.js';
        import './js/ui.helpers.js';
      </script>

<script type="module">
import { supa } from '../js/lib.supabase.js';
import { showToast, rlsGuard } from '../js/ui.helpers.js';

async function load() {
  const q = document.getElementById('q').value?.trim();
  let req = supa.from('proj.projects').select('id,name,status').order('created_at',{ascending:false});
  if (q) req = req.ilike('name', `%${q}%`);
  const { ok, data } = await rlsGuard(req, 'โหลดรายการโครงการไม่สำเร็จ');
  const tbody = document.getElementById('rows'); tbody.innerHTML = '';
  if (!ok || !data.length) { tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">ไม่พบรายการ</td></tr>`; return; }
  data.forEach((p,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${p.name}</td><td><span class="badge bg-secondary">${p.status||''}</span></td>
      <td class="text-nowrap">
        <a class="btn btn-sm btn-outline-primary" href="./board.html?pid=${p.id}">Board</a>
        <a class="btn btn-sm btn-outline-secondary" href="./timesheets.html?pid=${p.id}">Timesheet</a>
        <a class="btn btn-sm btn-outline-dark" href="./project-dashboard.html?pid=${p.id}">Dashboard</a>
      </td>`;
    tbody.appendChild(tr);
  })
}

document.getElementById('btnSearch').onclick = load;
document.getElementById('q').addEventListener('keydown', e=> { if(e.key==='Enter') load(); });
document.getElementById('btnNew').onclick = async ()=>{
  const name = prompt('ชื่อโครงการใหม่:');
  if (!name) return;
  const { ok } = await rlsGuard(supa.from('proj.projects').insert({ name }), 'สร้างโครงการไม่สำเร็จ');
  if (ok) { showToast('สร้างโครงการแล้ว','success'); load(); }
};
load();
</script>

    </body>
    </html>