<!doctype html>
    <html lang="th">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Project Dashboard</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body class="bg-light">
      <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
        <div class="container-fluid">
          <a class="navbar-brand fw-semibold">TPR Digital Hub</a>
          <div class="ms-auto d-flex gap-2">
            <a class="btn btn-sm btn-outline-secondary" href="./projects.html">Projects</a>
            <a class="btn btn-sm btn-outline-secondary" href="./timesheets.html">Timesheets</a>
            <a class="btn btn-sm btn-outline-secondary" href="./project-dashboard.html">Dashboard</a>
          </div>
        </div>
      </nav>
      <main class="container py-4">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="m-0">Project Dashboard</h3>
  <div>
    <select id="range" class="form-select form-select-sm">
      <option value="30">30 วัน</option>
      <option value="90" selected>90 วัน</option>
      <option value="365">365 วัน</option>
    </select>
  </div>
</div>
<div class="row g-4">
  <div class="col-md-4">
    <div class="card"><div class="card-body">
      <div class="text-muted">Total Hours</div>
      <div class="display-6 fw-bold" id="totalHours">0</div>
    </div></div>
  </div>
  <div class="col-md-8"><canvas id="hoursChart" height="120"></canvas></div>
</div>

      </main>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
      <script type="module">
        import './js/config.js';
        import './js/lib.supabase.js';
        import './js/ui.helpers.js';
      </script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
import { supa, qs } from '../js/lib.supabase.js';
import { rlsGuard } from '../js/ui.helpers.js';

const pid = qs('pid');
const ctx = document.getElementById('hoursChart').getContext('2d');
let chart = null;

async function load() {
  const days = Number(document.getElementById('range').value);
  const from = new Date(); from.setDate(from.getDate()-days);
  const fromISO = from.toISOString().slice(0,10);
  const { ok, data } = await rlsGuard(
    supa.from('proj.time_entries')
        .select('date,hours')
        .eq('project_id', pid)
        .gte('date', fromISO)
        .order('date'),
    'โหลดแดชบอร์ดไม่สำเร็จ'
  );
  if (!ok) return;
  const byDay = new Map();
  data.forEach(r => byDay.set(r.date, (byDay.get(r.date)||0) + Number(r.hours||0)));
  const labels = Array.from(byDay.keys());
  const values = Array.from(byDay.values());
  const total = values.reduce((a,b)=>a+b,0);
  document.getElementById('totalHours').textContent = total.toFixed(2);

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Hours', data: values }] },
    options: { responsive: true, plugins:{ legend:{ display:false } } }
  });
}

document.getElementById('range').onchange = load;
load();
</script>

    </body>
    </html>