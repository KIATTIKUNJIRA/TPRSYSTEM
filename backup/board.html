<!doctype html>
    <html lang="th">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Board</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body class="bg-light">
      <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
        <div class="container-fluid">
          <a class="navbar-brand fw-semibold">TPR Digital Hub</a>
          <div class="ms-auto d-flex gap-2">
            <a class="btn btn-sm btn-outline-secondary" href="./projects.html">Projects</a>
            <a class="btn btn-sm btn-outline-secondary" href="./timesheets.html">Timesheets</a>
            <a class="btn btn-sm btn-outline-secondary" href="./project-dashboard.html">Dashboard</a>
          </div>
        </div>
      </nav>
      <main class="container py-4">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="m-0">Project Board</h3>
  <div class="d-flex gap-2">
    <input id="newTitle" class="form-control" placeholder="ชื่องานใหม่">
    <button class="btn btn-primary" id="btnAdd">Add Card</button>
  </div>
</div>
<div class="row" id="board" style="min-height:60vh"></div>

      </main>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
      <script type="module">
        import './js/config.js';
        import './js/lib.supabase.js';
        import './js/ui.helpers.js';
      </script>

<script type="module">
import { supa, qs } from '../js/lib.supabase.js';
import { showToast, rlsGuard } from '../js/ui.helpers.js';

const pid = qs('pid');
const STATUSES = ['backlog','todo','in_progress','review','done'];

function colEl(status) {
  const div = document.createElement('div');
  div.className = 'col';
  div.innerHTML = `<div class="card">
    <div class="card-header bg-light fw-semibold text-capitalize">${status.replaceAll('_',' ')}</div>
    <div class="card-body d-grid gap-2" data-drop="${status}" style="min-height:300px"></div>
  </div>`;
  return div;
}

function cardEl(item) {
  const el = document.createElement('div');
  el.className = 'card p-2 border-2';
  el.draggable = true;
  el.dataset.id = item.id;
  el.innerHTML = `<div class="fw-semibold">${item.title}</div>
                  <div class="text-muted small">#${item.id}</div>`;
  el.addEventListener('dragstart', ev => {
    ev.dataTransfer.setData('text/plain', item.id);
  });
  return el;
}

async function loadBoard() {
  const board = document.getElementById('board'); board.innerHTML = '';
  STATUSES.forEach(s=> board.appendChild(colEl(s)));
  const { ok, data } = await rlsGuard(
    supa.from('proj.items').select('*').eq('project_id', pid).order('position'),
    'โหลดบอร์ดไม่สำเร็จ'
  );
  if (!ok) return;
  data.forEach(item=> {
    const body = document.querySelector(`[data-drop="${item.status||'backlog'}"]`);
    if (body) body.appendChild(cardEl(item));
  });
  initDnd();
}

function initDnd() {
  document.querySelectorAll('[data-drop]').forEach(zone => {
    zone.addEventListener('dragover', e => e.preventDefault());
    zone.addEventListener('drop', async e => {
      e.preventDefault();
      const id = Number(e.dataTransfer.getData('text/plain'));
      const status = zone.getAttribute('data-drop');
      const { ok } = await rlsGuard(
        supa.from('proj.items').update({ status }).eq('id', id),
        'ย้ายการ์ดไม่สำเร็จ'
      );
      if (ok) { showToast('ย้ายการ์ดแล้ว','success'); loadBoard(); }
    });
  });
}

document.getElementById('btnAdd').onclick = async ()=>{
  const title = document.getElementById('newTitle').value.trim();
  if (!title) return;
  const { ok } = await rlsGuard(
    supa.from('proj.items').insert({ project_id: pid, title, status:'backlog' }),
    'สร้างการ์ดไม่สำเร็จ'
  );
  if (ok) { document.getElementById('newTitle').value=''; loadBoard(); }
};

loadBoard();
</script>

    </body>
    </html>