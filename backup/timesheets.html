<!doctype html>
    <html lang="th">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Timesheets</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body class="bg-light">
      <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
        <div class="container-fluid">
          <a class="navbar-brand fw-semibold">TPR Digital Hub</a>
          <div class="ms-auto d-flex gap-2">
            <a class="btn btn-sm btn-outline-secondary" href="./projects.html">Projects</a>
            <a class="btn btn-sm btn-outline-secondary" href="./timesheets.html">Timesheets</a>
            <a class="btn btn-sm btn-outline-secondary" href="./project-dashboard.html">Dashboard</a>
          </div>
        </div>
      </nav>
      <main class="container py-4">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="m-0">Timesheets</h3>
  <div class="d-flex gap-2">
    <input type="date" id="teDate" class="form-control">
    <input type="number" id="teHours" class="form-control" min="0" step="0.25" placeholder="ชั่วโมง">
    <input id="teNotes" class="form-control" placeholder="บันทึก/หมายเหตุ">
    <select id="teItem" class="form-select" style="min-width:220px"></select>
    <button class="btn btn-primary" id="btnLog">Log time</button>
  </div>
</div>
<table class="table table-sm table-striped">
  <thead><tr><th>วันที่</th><th>งาน</th><th>ชั่วโมง</th><th>หมายเหตุ</th></tr></thead>
  <tbody id="rows"><tr><td colspan="4" class="text-center text-muted py-4">กำลังโหลด...</td></tr></tbody>
</table>

      </main>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
      <script type="module">
        import './js/config.js';
        import './js/lib.supabase.js';
        import './js/ui.helpers.js';
      </script>

<script type="module">
import { supa, qs } from '../js/lib.supabase.js';
import { showToast, rlsGuard } from '../js/ui.helpers.js';

const pid = qs('pid');

async function loadItems() {
  const sel = document.getElementById('teItem');
  const { ok, data } = await rlsGuard(
    supa.from('proj.items').select('id,title').eq('project_id', pid).order('title'),
    'โหลดรายการงานไม่สำเร็จ'
  );
  sel.innerHTML = '';
  if (ok) {
    data.forEach(x => {
      const o = document.createElement('option'); o.value = x.id; o.textContent = `${x.title}`; sel.appendChild(o);
    });
  }
}

async function loadLogs() {
  const tb = document.getElementById('rows'); tb.innerHTML='';
  const { ok, data } = await rlsGuard(
    supa.from('proj.time_entries').select('date,hours,notes,item_id,items!inner(title)').eq('project_id', pid).order('date', {ascending:false}).limit(100),
    'โหลด timesheet ไม่สำเร็จ'
  );
  if (!ok) return tb.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">ไม่พบข้อมูล</td></tr>`;
  if (!data.length) { tb.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">ยังไม่มีรายการ</td></tr>`; return; }
  data.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.items?.title||''}</td><td>${r.hours}</td><td>${r.notes||''}</td>`;
    tb.appendChild(tr);
  });
}

document.getElementById('btnLog').onclick = async ()=> {
  const body = {
    project_id: pid,
    item_id: Number(document.getElementById('teItem').value),
    date: document.getElementById('teDate').value,
    hours: Number(document.getElementById('teHours').value || 0),
    notes: document.getElementById('teNotes').value || null
  };
  if (!body.date || !body.hours || !body.item_id) return showToast('กรอกวันที่/ชั่วโมง/งาน ให้ครบ','warning');
  const { ok } = await rlsGuard(
    supa.from('proj.time_entries').insert(body),
    'บันทึกเวลางานไม่สำเร็จ'
  );
  if (ok) { showToast('บันทึกแล้ว','success'); loadLogs(); }
};

// default date today
document.getElementById('teDate').valueAsDate = new Date();
await loadItems();
await loadLogs();
</script>

    </body>
    </html>