
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boards ‚Äî TPR Digital Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="./shared.css" rel="stylesheet">
</head>
<body>
  <div id="navbar"></div>
  <div class="container-narrow">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="d-flex align-items-center gap-2">
        <h4 class="mb-0">Boards</h4>
        <span class="badge-soft">Monday-like</span>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-soft" id="btnAddColumn">+ Column</button>
        <button class="btn btn-soft" id="btnAddItem">+ Item</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-lg-8">
        <div id="board" class="board"></div>
      </div>
      <div class="col-lg-4">
        <div class="card p-3 right-pane">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Item Inspector</h5>
            <span class="badge text-bg-secondary" id="selItemId">‚Äî</span>
          </div>
          <hr class="my-3">
          <div id="inspectorNone" class="small-muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
          <div id="inspector" class="d-none">
            <div class="mb-2">
              <label class="form-label">Title</label>
              <input id="f_title" class="form-control" />
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Assignee (People)</label>
                <select id="f_assignee" class="form-select"></select>
              </div>
              <div class="col-6">
                <label class="form-label">Due (Date)</label>
                <input type="date" id="f_due" class="form-control" />
              </div>
            </div>
            <div class="row g-2 mt-1">
              <div class="col-6">
                <label class="form-label">Priority (Status)</label>
                <select id="f_priority" class="form-select">
                  <option>Low</option><option>Medium</option><option>High</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label">Story Points (Number)</label>
                <input id="f_points" type="number" class="form-control" step="0.5" />
              </div>
            </div>
            <div class="mt-2">
              <label class="form-label">Tags</label>
              <div class="d-flex gap-2">
                <input id="f_tagInput" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ó‡πá‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter" />
                <button class="btn btn-soft" id="btnClearTags">Clear</button>
              </div>
              <div id="f_tags" class="mt-2"></div>
            </div>
            <div class="text-end mt-3">
              <button class="btn btn-primary" id="btnSaveItem">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="columnModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (Custom Column)</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</label>
            <input id="colName" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô In Review" />
          </div>
          <div class="mb-2">
            <label class="form-label">‡∏ä‡∏ô‡∏¥‡∏î</label>
            <select id="colType" class="form-select">
              <option value="status">Status</option>
              <option value="people">People</option>
              <option value="date">Date</option>
              <option value="number">Number</option>
              <option value="tags">Tags</option>
            </select>
          </div>
          <div class="small-muted">‡∏ä‡∏ô‡∏¥‡∏î Status ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ö‡∏ô‡∏ö‡∏≠‡∏£‡πå‡∏î (‡∏•‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ)</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-soft" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" id="btnAddColConfirm">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import {PEOPLE, PROJECTS, BOARD_COLUMNS, BOARD_ITEMS, personName, renderNavbar} from './shared.js';
    document.getElementById('navbar').innerHTML = renderNavbar('boards');

    let boardColumns = BOARD_COLUMNS;
    let boardItems = BOARD_ITEMS.filter(i=> i.project_id===PROJECTS[0].id);
    const people = PEOPLE;

    const boardEl = document.getElementById('board');
    let selectedId = null;

    function renderBoard(){
      boardEl.innerHTML='';
      const cols = boardColumns.filter(c=> c.project_id===PROJECTS[0].id).sort((a,b)=> a.order_index-b.order_index);
      cols.forEach(col=>{
        const c = document.createElement('div');
        c.className='column';
        c.dataset.colId = col.id;
        c.innerHTML = \`
          <div class="column-header">
            <span class="fw-semibold">\${col.name}</span>
            <button class="btn btn-sm btn-soft" data-add="\${col.id}">+ Add</button>
          </div>
          <div class="dropzone" data-zone="\${col.id}"></div>
        \`;
        const zone = c.querySelector('.dropzone');
        boardItems.filter(i=> i.column_id===col.id).forEach(it=> zone.appendChild(renderItem(it)));
        boardEl.appendChild(c);
      });
      document.querySelectorAll('button[data-add]').forEach(b=> b.onclick = ()=> addItemTo(Number(b.dataset.add)) );
      enableDnD();
    }

    function renderItem(it){
      const el = document.createElement('div');
      el.className='item'; el.draggable = true; el.dataset.id = it.id;
      el.innerHTML = \`
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">\${it.title}</div>
          <span class="badge-soft">\${it.priority}</span>
        </div>
        <div class="d-flex gap-3 mt-1 small small-muted">
          <span>üë§ \${personName(it.assignee_id)}</span>
          <span>üìÖ \${it.due_date}</span>
          <span>‚≠ê \${it.points||0}</span>
        </div>
        <div class="mt-2">\${(it.tags||[]).map(t=>`<span class='tag'>\${t}</span>`).join('')}</div>
      \`;
      el.onclick = ()=> openInspector(it.id);
      return el;
    }

    function enableDnD(){
      document.querySelectorAll('.item').forEach(it=>{
        it.addEventListener('dragstart', e=>{
          e.dataTransfer.setData('text/plain', it.dataset.id);
          it.classList.add('dragging');
        });
        it.addEventListener('dragend', ()=> it.classList.remove('dragging'));
      });
      document.querySelectorAll('.dropzone').forEach(zone=>{
        zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.classList.add('ghost'); });
        zone.addEventListener('dragleave', ()=> zone.classList.remove('ghost'));
        zone.addEventListener('drop', e=>{
          e.preventDefault(); zone.classList.remove('ghost');
          const id = Number(e.dataTransfer.getData('text/plain'));
          const colId = Number(zone.dataset.zone);
          const idx = boardItems.findIndex(x=> x.id===id);
          if (idx>=0){ boardItems[idx].column_id = colId; renderBoard(); if(selectedId===id) openInspector(id); }
        });
      });
    }

    // Inspector
    const selBadge = document.getElementById('selItemId');
    const inspNone = document.getElementById('inspectorNone');
    const insp = document.getElementById('inspector');
    const fTitle = document.getElementById('f_title');
    const fAssignee = document.getElementById('f_assignee');
    const fDue = document.getElementById('f_due');
    const fPriority = document.getElementById('f_priority');
    const fPoints = document.getElementById('f_points');
    const fTagInput = document.getElementById('f_tagInput');
    const fTags = document.getElementById('f_tags');

    people.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id; opt.textContent = \`\${p.first_name} \${p.last_name}\`; fAssignee.appendChild(opt);
    });

    function openInspector(id){
      selectedId = id; selBadge.textContent = \`#\${id}\`;
      inspNone.classList.add('d-none'); insp.classList.remove('d-none');
      const it = boardItems.find(x=> x.id===id);
      fTitle.value = it.title || '';
      fAssignee.value = it.assignee_id || '';
      fDue.value = it.due_date || '';
      fPriority.value = it.priority || 'Medium';
      fPoints.value = it.points || 0;
      renderTags(it.tags||[]);
    }
    function renderTags(arr){ fTags.innerHTML = arr.map(t=> `<span class='tag'>\${t}</span>`).join(''); }
    fTagInput.addEventListener('keydown', e=>{
      if (e.key==='Enter'){
        e.preventDefault();
        const v = fTagInput.value.trim(); if(!v) return;
        const it = boardItems.find(x=> x.id===selectedId);
        it.tags = [...(it.tags||[]), v];
        fTagInput.value=''; renderTags(it.tags); renderBoard();
      }
    });
    document.getElementById('btnClearTags').onclick = ()=> {
      const it = boardItems.find(x=> x.id===selectedId); it.tags=[]; renderTags([]); renderBoard();
    };
    document.getElementById('btnSaveItem').onclick = ()=>{
      const it = boardItems.find(x=> x.id===selectedId);
      if (!it) return;
      it.title = fTitle.value.trim();
      it.assignee_id = Number(fAssignee.value);
      it.due_date = fDue.value;
      it.priority = fPriority.value;
      it.points = Number(fPoints.value||0);
      renderBoard();
    };

    // Add column / item
    const columnModal = new bootstrap.Modal(document.getElementById('columnModal'));
    document.getElementById('btnAddColumn').onclick = ()=>{ document.getElementById('colName').value=''; document.getElementById('colType').value='status'; columnModal.show(); };
    document.getElementById('btnAddColConfirm').onclick = ()=>{
      const name = document.getElementById('colName').value.trim();
      const type = document.getElementById('colType').value;
      if (!name) return;
      const cols = boardColumns.filter(c=> c.project_id===PROJECTS[0].id);
      const maxOrder = Math.max(...cols.map(c=>c.order_index));
      boardColumns.push({ id: Date.now(), project_id:PROJECTS[0].id, name, order_index:maxOrder+1, type });
      columnModal.hide(); renderBoard();
    };
    document.getElementById('btnAddItem').onclick = ()=> addItemTo(boardColumns.find(c=> c.project_id===PROJECTS[0].id)?.id);
    function addItemTo(colId){
      const id = Date.now();
      boardItems.push({ id, project_id:PROJECTS[0].id, column_id:colId, title:'New item', assignee_id:people[0].id, due_date:'', priority:'Medium', points:1, tags:[] });
      renderBoard(); openInspector(id);
    }

    renderBoard();
  </script>
</body>
</html>
